<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover, user-scalable=no"/>
    <title>Studio AR | Spatial Pro</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <style>
        :root {
            --bg: #000000;
            --glass: rgba(10, 10, 10, 0.85);
            --border: rgba(255, 255, 255, 0.15);
            --accent: #ffffff;
            --active: #59ffd3;
            --text: #ffffff;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body {
            height: 100vh;
            background: var(--bg);
            font-family: 'Inter', sans-serif;
            overflow: hidden;
            color: var(--text);
        }

        /* UI Layers */
        #ui-layer { position: fixed; inset: 0; z-index: 100; pointer-events: none; }
        #ui-layer * { pointer-events: auto; }

        /* --- SPLASH --- */
        #splash {
            position: fixed;
            inset: 0;
            background: #000;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            transition: opacity 0.8s ease;
        }

        .logo-mark {
            width: 40px; height: 40px;
            border: 2px solid #fff;
            transform: rotate(45deg);
            margin-bottom: 20px;
            animation: pulse 2s infinite;
        }

        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.3; } }

        /* --- CONTROLS --- */
        .panel {
            position: absolute;
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            background: var(--glass);
            border: 1px solid var(--border);
            display: flex;
            align-items: center;
        }

        .top-bar {
            top: 20px; left: 50%;
            transform: translateX(-50%);
            width: 90%; max-width: 400px;
            height: 60px; padding: 0 20px;
            border-radius: 100px;
            justify-content: space-between;
        }

        .dock {
            bottom: 30px; left: 50%;
            transform: translateX(-50%);
            padding: 10px; border-radius: 30px;
            gap: 12px;
        }

        .btn {
            background: rgba(255,255,255,0.05);
            border: none; color: #fff;
            width: 50px; height: 50px;
            border-radius: 20px;
            display: flex; align-items: center; justify-content: center;
            cursor: pointer; transition: 0.2s;
        }

        .btn:active { transform: scale(0.9); }
        .btn.active { color: var(--active); box-shadow: 0 0 15px rgba(89,255,211,0.2); }
        .btn.primary { background: #fff; color: #000; width: 60px; height: 60px; border-radius: 25px; }

        svg { width: 22px; height: 22px; fill: none; stroke: currentColor; stroke-width: 2; }

        /* AR Hint */
        #hint {
            position: fixed; bottom: 120px; left: 50%;
            transform: translateX(-50%);
            background: rgba(0,0,0,0.7);
            padding: 8px 16px; border-radius: 20px;
            font-size: 12px; opacity: 0.8;
            display: none;
        }
    </style>
</head>
<body>

<div id="splash">
    <div class="logo-mark"></div>
    <h1 style="letter-spacing: 5px; font-weight: 300;">STUDIO AR</h1>
    <p style="font-size: 10px; margin-top: 8px; color: #666; letter-spacing: 2px;">BY SILENT PROGRAMMER</p>
</div>

<div id="hint">Point at your paper and tap "Anchor"</div>

<div id="ui-layer">
    <div class="panel top-bar">
        <button class="btn" onclick="document.getElementById('file-input').click()">
            <svg viewBox="0 0 24 24"><path d="M12 5v14M5 12h14"/></svg>
        </button>
        <span style="font-size: 11px; font-weight: 600; color: #666;">SPATIAL ENGINE V3</span>
        <button class="btn" id="torchToggle">
            <svg viewBox="0 0 24 24"><path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z"/></svg>
        </button>
    </div>

    <div class="panel dock">
        <button class="btn" id="lockMode" title="Spatial Lock">
            <svg viewBox="0 0 24 24"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/><circle cx="12" cy="10" r="3"/></svg>
        </button>
        <button class="btn primary" id="ar-button">
            <svg viewBox="0 0 24 24"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg>
        </button>
        <button class="btn" id="resetBtn">
            <svg viewBox="0 0 24 24"><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8M3 3v5h5"/></svg>
        </button>
    </div>
</div>

<input type="file" id="file-input" accept="image/*" hidden>

<script>
    let scene, camera, renderer, arSource, imageMesh;
    let isARActive = false;
    let selectedImage = null;

    // --- INITIALIZATION ---
    window.onload = () => {
        setTimeout(() => {
            document.getElementById('splash').style.opacity = '0';
            setTimeout(() => document.getElementById('splash').remove(), 800);
        }, 2000);
        initThree();
    };

    function initThree() {
        scene = new THREE.Scene();
        camera = new THREE.PerspectiveCamera(70, window.innerWidth / window.innerHeight, 0.01, 20);
        
        renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
        renderer.setPixelRatio(window.devicePixelRatio);
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.xr.enabled = true;
        document.body.appendChild(renderer.domElement);

        const light = new THREE.HemisphereLight(0xffffff, 0xbbbbff, 1);
        scene.add(light);
    }

    // --- IMAGE LOADING ---
    document.getElementById('file-input').onchange = (e) => {
        const reader = new FileReader();
        reader.onload = (event) => {
            const loader = new THREE.TextureLoader();
            loader.load(event.target.result, (texture) => {
                createImagePlane(texture);
            });
        };
        reader.readAsDataURL(e.target.files[0]);
    };

    function createImagePlane(texture) {
        if (imageMesh) scene.remove(imageMesh);
        
        const aspect = texture.image.width / texture.image.height;
        const geometry = new THREE.PlaneGeometry(0.3 * aspect, 0.3);
        const material = new THREE.MeshBasicMaterial({ 
            map: texture, 
            transparent: true, 
            opacity: 0.7,
            side: THREE.DoubleSide
        });
        
        imageMesh = new THREE.Mesh(geometry, material);
        // Place in front of camera initially
        imageMesh.position.set(0, 0, -0.5); 
        scene.add(imageMesh);
    }

    // --- AR SESSION ---
    const arButton = document.getElementById('ar-button');
    arButton.onclick = async () => {
        if (!isARActive) {
            const sessionInit = { requiredFeatures: ['hit-test'] };
            const session = await navigator.xr.requestSession('immersive-ar', sessionInit);
            renderer.xr.setSession(session);
            arButton.classList.add('active');
            document.getElementById('hint').style.display = 'block';
            isARActive = true;
        }
    };

    // --- GESTURE LOGIC (Spatial) ---
    let initialTouchDist = 0;
    let initialScale = 1;

    window.addEventListener('touchstart', (e) => {
        if (e.touches.length === 2) {
            initialTouchDist = Math.hypot(
                e.touches[0].pageX - e.touches[1].pageX,
                e.touches[0].pageY - e.touches[1].pageY
            );
            if(imageMesh) initialScale = imageMesh.scale.x;
        }
    });

    window.addEventListener('touchmove', (e) => {
        if (!imageMesh) return;

        if (e.touches.length === 1) {
            // One finger drag in 3D Space
            imageMesh.position.x += e.movementX * 0.001;
            imageMesh.position.y -= e.movementY * 0.001;
        } 
        else if (e.touches.length === 2) {
            // Two finger zoom
            const currentDist = Math.hypot(
                e.touches[0].pageX - e.touches[1].pageX,
                e.touches[0].pageY - e.touches[1].pageY
            );
            const scaleFactor = currentDist / initialTouchDist;
            imageMesh.scale.set(initialScale * scaleFactor, initialScale * scaleFactor, 1);
        }
    });

    // --- RENDER LOOP ---
    renderer.setAnimationLoop((timestamp, frame) => {
        if (frame && isARActive) {
            // If the user wants to "lock" to a surface, 
            // WebXR handles the spatial persistence automatically.
        }
        renderer.render(scene, camera);
    });

    // --- UTILS ---
    document.getElementById('resetBtn').onclick = () => {
        if (imageMesh) {
            imageMesh.position.set(0, 0, -0.5);
            imageMesh.rotation.set(0, 0, 0);
            imageMesh.scale.set(1, 1, 1);
        }
    };

    document.getElementById('lockMode').onclick = () => {
        document.getElementById('lockMode').classList.toggle('active');
        // Logic to disable movement
    };
</script>
</body>
</html>
